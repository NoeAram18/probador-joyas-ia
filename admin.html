<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gedalia Admin | ERP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #c5a059; --black: #0a0a0a; --bg: #f4f7f6; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); display: flex; }
        .sidebar { width: 260px; background: var(--black); height: 100vh; color: white; padding: 30px; position: fixed; }
        .main { margin-left: 260px; padding: 40px; width: calc(100% - 260px); }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 5px; }
        .badge-v { background: #e3f2fd; color: #1976d2; }
        .badge-i { background: #fff3e0; color: #ef6c00; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { cursor: pointer; border: none; border-radius: 6px; padding: 10px 15px; font-weight: 600; transition: 0.2s; }
        .btn-stock { background: #f0f0f0; font-size: 11px; }
        .btn-stock.on { background: #e8f5e9; color: #2e7d32; }
        .btn-edit { background: var(--gold); color: white; }
        .btn-del { background: #ffebee; color: #c62828; }
        .section { display: none; }
        .active { display: block; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="color:var(--gold); letter-spacing:2px;">GEDALIA</h2>
    <div style="margin-top:40px;">
        <p onclick="showSection('inventory')" style="cursor:pointer; padding:10px 0;">üíé Cat√°logo & Stats</p>
        <p onclick="prepareNew()" style="cursor:pointer; padding:10px 0;">‚ú® Nueva Joya</p>
    </div>
</div>

<div class="main">
    <div id="inventory" class="section active">
        <div class="card">
            <h3>Gesti√≥n de Inventario</h3>
            <table>
                <thead>
                    <tr>
                        <th>Pieza</th>
                        <th>M√©tricas</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="lista-prods"></tbody>
            </table>
        </div>
    </div>

    <div id="form-section" class="section">
        <div class="card">
            <h3 id="form-title">Nueva Publicaci√≥n</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="n" placeholder="Nombre de la pieza">
            <select id="c">
                <option value="Anillos">Anillos</option>
                <option value="Dije">Dije</option>
                <option value="Collares">Collares</option>
                <option value="Aretes">Aretes</option>
                <option value="Pulseras">Pulseras</option>
            </select>
            <div style="display:flex; gap:10px;">
                <input type="number" id="p" placeholder="Precio USD">
                <input type="number" id="desc" placeholder="% Descuento">
            </div>
            <select id="envio">
                <option value="false">Env√≠o Pagado</option>
                <option value="true">Env√≠o Gratis</option>
            </select>
            <p style="font-size:12px; color:var(--gold);">Fotos (Subir solo las que desea cambiar/agregar):</p>
            <input type="file" id="f1">
            <input type="file" id="f2">
            <input type="file" id="f3">
            <button id="btn-save" style="background:var(--black); color:white; width:100%; margin-top:20px; padding:15px;" onclick="guardar()">GUARDAR CAMBIOS EN GEDALIA</button>
            <button style="background:#eee; width:100%; margin-top:10px;" onclick="showSection('inventory')">CANCELAR</button>
        </div>
    </div>
</div>

<script>
    let localProds = [];

    async function cargarData() {
        const res = await fetch('/api/admin/productos-todos');
        localProds = await res.json();
        document.getElementById('lista-prods').innerHTML = localProds.map(p => `
            <tr>
                <td><b>${p.nombre}</b><br><small>${p.categoria}</small></td>
                <td>
                    <span class="badge badge-v">${p.vistas} üëÄ</span>
                    <span class="badge badge-i">${p.interacciones} ‚ö°</span>
                </td>
                <td>
                    <button class="btn-stock ${p.stock?'on':''}" onclick="toggleStock('${p._id}', ${p.stock})">
                        ${p.stock ? 'DISPONIBLE' : 'AGOTADO'}
                    </button>
                </td>
                <td>
                    <button class="btn-edit" onclick="editar('${p._id}')">Editar</button>
                    <button class="btn-del" onclick="eliminar('${p._id}')">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function prepareNew() {
        document.getElementById('edit-id').value = "";
        document.getElementById('form-title').innerText = "Nueva Publicaci√≥n";
        document.querySelectorAll('input').forEach(i => i.value = "");
        showSection('form-section');
    }

    function editar(id) {
        const p = localProds.find(x => x._id === id);
        document.getElementById('edit-id').value = p._id;
        document.getElementById('n').value = p.nombre;
        document.getElementById('c').value = p.categoria;
        document.getElementById('p').value = p.precioBase;
        document.getElementById('desc').value = p.descuento;
        document.getElementById('envio').value = p.envioGratis.toString();
        document.getElementById('form-title').innerText = "Editando: " + p.nombre;
        showSection('form-section');
    }

    async function toggleStock(id, current) {
        await fetch(`/api/admin/productos/${id}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ stock: !current })
        });
        cargarData();
    }

    async function guardar() {
        const btn = document.getElementById('btn-save');
        btn.disabled = true;
        btn.innerText = "PROCESANDO...";

        const id = document.getElementById('edit-id').value;
        const fotos = [document.getElementById('f1').files[0], document.getElementById('f2').files[0], document.getElementById('f3').files[0]];
        let nuevasUrls = [];

        for(let f of fotos) {
            if(f) {
                const fd = new FormData();
                fd.append('image', f);
                const r = await fetch('/api/admin/upload-image', { method: 'POST', body: fd });
                const d = await r.json();
                nuevasUrls.push(d.url);
            }
        }

        const payload = {
            nombre: document.getElementById('n').value,
            categoria: document.getElementById('c').value,
            precioBase: Number(document.getElementById('p').value),
            descuento: Number(document.getElementById('desc').value) || 0,
            envioGratis: document.getElementById('envio').value === "true"
        };
        if(nuevasUrls.length > 0) payload.imagenes = nuevasUrls;

        await fetch(id ? `/api/admin/productos/${id}` : '/api/admin/productos', {
            method: id ? 'PATCH' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        alert("Operaci√≥n completada");
        btn.disabled = false;
        btn.innerText = "GUARDAR CAMBIOS EN GEDALIA";
        cargarData();
        showSection('inventory');
    }

    async function eliminar(id) {
        if(confirm("¬øEliminar permanentemente?")) {
            await fetch(`/api/admin/productos/${id}`, { method: 'DELETE' });
            cargarData();
        }
    }

    cargarData();
</script>
</body>
</html>
