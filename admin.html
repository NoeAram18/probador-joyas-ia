<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gedalia ERP | Estrategia</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #c5a059; --black: #0a0a0a; --bg: #f8f9fa; }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; background: var(--bg); }
        .sidebar { width: 260px; background: var(--black); height: 100vh; color: white; padding: 40px 20px; position: fixed; }
        .main { margin-left: 260px; padding: 40px; width: 100%; box-sizing: border-box; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid var(--gold); }
        .stat-card h4 { margin: 0; color: #888; font-size: 12px; text-transform: uppercase; }
        .stat-card p { margin: 10px 0 0; font-size: 24px; font-weight: 700; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; width: 100px; }
        .progress-fill { height: 100%; background: var(--gold); }
        .btn-edit { background: var(--gold); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
        .section { display: none; }
        .active { display: block; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="color:var(--gold)">GEDALIA</h2>
    <p onclick="showSection('stats')" style="cursor:pointer; margin-top:30px;">üìä Dashboard Estrat√©gico</p>
    <p onclick="showSection('inventory')" style="cursor:pointer">üíé Gesti√≥n de Stock</p>
    <p onclick="prepareNew()" style="cursor:pointer">‚ú® Nueva Joya</p>
</div>

<div class="main">
    <div id="stats" class="section active">
        <div class="stat-grid">
            <div class="stat-card"><h4>Vistas Totales</h4><p id="total-vistas">0</p></div>
            <div class="stat-card"><h4>Inter√©s de Compra</h4><p id="total-clicks">0</p></div>
            <div class="stat-card"><h4>Tasa de Conversi√≥n</h4><p id="conversion-avg">0%</p></div>
        </div>
        <div class="card">
            <h3>An√°lisis por Producto (Top Inter√©s)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Vistas</th>
                        <th>Deseado por</th>
                        <th>% Relevancia</th>
                    </tr>
                </thead>
                <tbody id="tabla-stats"></tbody>
            </table>
        </div>
    </div>

    <div id="inventory" class="section">
        <div class="card">
            <h3>Inventario Activo</h3>
            <table id="lista-prods"></table>
        </div>
    </div>

    <div id="form-section" class="section">
        <div class="card">
            <h3 id="form-title">Publicar Pieza</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="n" placeholder="Nombre">
            <select id="c"><option value="Anillos">Anillos</option><option value="Dije">Dije</option><option value="Collares">Collares</option><option value="Aretes">Aretes</option><option value="Pulseras">Pulseras</option></select>
            <input type="number" id="p" placeholder="Precio USD">
            <input type="number" id="desc" placeholder="% Descuento">
            <select id="envio"><option value="false">Env√≠o Pagado</option><option value="true">Env√≠o Gratis</option></select>
            <input type="file" id="f1"><input type="file" id="f2"><input type="file" id="f3">
            <button id="btn-save" class="btn-edit" style="width:100%; padding:15px; margin-top:20px;" onclick="guardar()">GUARDAR</button>
        </div>
    </div>
</div>

<script>
    let productos = [];

    async function cargar() {
        const res = await fetch('/api/admin/productos-todos');
        productos = await res.json();
        renderStats();
        renderInventory();
    }

    function renderStats() {
        const totalVistas = productos.reduce((a, b) => a + b.vistas, 0);
        const totalClicks = productos.reduce((a, b) => a + b.interacciones, 0);
        const avgConv = totalVistas > 0 ? ((totalClicks / totalVistas) * 100).toFixed(1) : 0;

        document.getElementById('total-vistas').innerText = totalVistas;
        document.getElementById('total-clicks').innerText = totalClicks;
        document.getElementById('conversion-avg').innerText = avgConv + "%";

        document.getElementById('tabla-stats').innerHTML = productos.slice(0, 10).map(p => {
            const perc = p.vistas > 0 ? ((p.interacciones / p.vistas) * 100).toFixed(1) : 0;
            return `
                <tr>
                    <td><b>${p.nombre}</b></td>
                    <td>${p.vistas}</td>
                    <td>${p.interacciones} clientes</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px">
                            <div class="progress-bar"><div class="progress-fill" style="width:${perc}%"></div></div>
                            <span>${perc}%</span>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function renderInventory() {
        document.getElementById('lista-prods').innerHTML = productos.map(p => `
            <tr>
                <td>${p.nombre}</td>
                <td>$${p.precioBase}</td>
                <td>${p.stock ? '‚úÖ' : '‚ùå'}</td>
                <td><button class="btn-edit" onclick="editar('${p._id}')">Editar</button></td>
            </tr>
        `).join('');
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function prepareNew() { 
        document.getElementById('edit-id').value = ""; 
        document.querySelectorAll('input').forEach(i => i.value = "");
        showSection('form-section'); 
    }

    function editar(id) {
        const p = productos.find(x => x._id === id);
        document.getElementById('edit-id').value = p._id;
        document.getElementById('n').value = p.nombre;
        document.getElementById('p').value = p.precioBase;
        document.getElementById('desc').value = p.descuento;
        showSection('form-section');
    }

    async function procesarImg(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 1200; canvas.height = (img.height * 1200) / img.width;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(async b => {
                        const fd = new FormData(); fd.append('image', b);
                        const r = await fetch('/api/admin/upload-image', { method: 'POST', body: fd });
                        const d = await r.json(); resolve(d.url);
                    }, 'image/jpeg', 0.8);
                }
            }
        });
    }

    async function guardar() {
        const id = document.getElementById('edit-id').value;
        const urls = [];
        const files = [document.getElementById('f1').files[0], document.getElementById('f2').files[0], document.getElementById('f3').files[0]];
        for(let f of files) { if(f) urls.push(await procesarImg(f)); }

        const payload = {
            nombre: document.getElementById('n').value,
            categoria: document.getElementById('c').value,
            precioBase: Number(document.getElementById('p').value),
            descuento: Number(document.getElementById('desc').value),
            envioGratis: document.getElementById('envio').value === "true"
        };
        if(urls.length > 0) payload.imagenes = urls;

        await fetch(id ? `/api/admin/productos/${id}` : '/api/admin/productos', {
            method: id ? 'PATCH' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        alert("¬°Listo!"); cargar(); showSection('inventory');
    }

    cargar();
</script>
</body>
</html>
